<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>AWS EKS Terraform 작성 - Ryusstory</title><script>(function(a,b){a[b]=a[b].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content="Example article description"><meta property="og:title" content="AWS EKS Terraform 작성"><meta property="og:description" content="Example article description"><meta property="og:type" content="article"><meta property="og:url" content="https://ryusstory.github.io/post/210918-eks-terraform/"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-09-15T21:52:55+09:00"><meta property="article:modified_time" content="2021-09-15T21:52:55+09:00"><meta itemprop=name content="AWS EKS Terraform 작성"><meta itemprop=description content="Example article description"><meta itemprop=datePublished content="2021-09-15T21:52:55+09:00"><meta itemprop=dateModified content="2021-09-15T21:52:55+09:00"><meta itemprop=wordCount content="1565"><meta itemprop=keywords content="terraform,akos,eks,aws,"><meta name=twitter:card content="summary"><meta name=twitter:title content="AWS EKS Terraform 작성"><meta name=twitter:description content="Example article description"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class="logo logo--mixed"><a class=logo__link href=/ title=Ryusstory rel=home><div class="logo__item logo__imagebox"><img class=logo__img src=/img/noise.jpg></div><div class="logo__item logo__text"><div class=logo__title>Ryusstory</div><div class=logo__tagline>Brainprints</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class="menu__item menu__item--active"><a class=menu__link href=/post/210918-eks-terraform/><span class=menu__text>AWS EKS Terraform 작성</span></a></li><li class=menu__item><a class=menu__link href=/post/210916-helloworld/><span class=menu__text>Hello World</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>AWS EKS Terraform 작성</h1><p class=post__lead>테라폼으로 AWS EKS 배포하기</p><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>Ryusstory</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2021-09-15T21:52:55+09:00>2021-09-15</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/tech/ rel=category>tech</a></span></div></div></header><div class="post__toc toc"><div class=toc__title>Page content</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#akos-스터디>AKOS 스터디</a><ul><li><a href=#테라포밍>테라포밍</a></li><li><a href=#테라폼-템플릿>테라폼 템플릿</a></li></ul></li><li><a href=#사용법-설명>사용법 설명</a><ul><li><a href=#git-clone>git clone</a></li><li><a href=#aws-credential-설정>AWS credential 설정</a></li><li><a href=#테라폼-설치>테라폼 설치</a></li><li><a href=#테라폼-실행>테라폼 실행</a></li><li><a href=#변수-설정>변수 설정</a></li><li><a href=#배포-완료-후-kubectl-설정>배포 완료 후 kubectl 설정</a></li><li><a href=#bastion-host에서-kubectl-사용하기-kubectl권한을-다른-iam-사용자에게도-설정>bastion host에서 kubectl 사용하기 (kubectl권한을 다른 IAM 사용자에게도 설정)</a></li><li><a href=#option-bastion_host-접속-시-윈도우에서-keypair-파일-권한>(option) bastion_host 접속 시 윈도우에서 keypair 파일 권한</a></li><li><a href=#파일설명>파일설명</a></li><li><a href=#위-내용을-구성도로-그리면-아래와-같다>위 내용을 구성도로 그리면 아래와 같다.</a></li></ul></li><li><a href=#aws-eks-on-nodegroup>AWS EKS on Nodegroup</a></li><li><a href=#aws-eks-on-fargate>AWS EKS on Fargate</a><ul><li><a href=#리소스-삭제>리소스 삭제</a></li></ul></li></ul></nav></div></div><div class="content post__content clearfix"><h2 id=akos-스터디>AKOS 스터디</h2><p>CloudNet@에서 진행하는 AKOS(AWS Kubernetes Online Study)를 진행하면서 자체적으로 Cloudformation 템플릿을 제공했는데, 이를 테라폼으로 사용해 보고 싶었다.</p><h3 id=테라포밍>테라포밍</h3><p>현재 사용하고 있는 메인 툴이 클라우드 포메이션이기도 하고, 과거에 클라우드 포메이션으로 약간 아쉬운 점도 있었기에, EKS 테라포밍으로 공부하면서 스터디를 할 생각으로 테라폼으로 이를 작성 해봤다.</p><blockquote><p>테라폼과 클라우드포메이션 등 리소스를 배포하는데는 다양한 방법이 있는데 어떤 방식을 사용해도 장단점은 존재하며 그걸 어떻게 수용할지는 본인의 선택이다.<br>예를 들면 테라폼에서 프로그래밍 혹은 bash에서 curl로 다양한 값들을 가져와서 처리하고 싶지만 그러기엔 좀 더 HCL(Hashcorp Configuration Language)을 깊게 공부해야 하며 나름의 한계가 보이는 부분도 있다.<br>Python의 boto3를 사용해 리소스 배포와 같은 스크립트를 작성한다고 하면 클라우드포메이션이나 테라폼같은 툴들과는 다른 자유도에 행복할 수 있으나 기존의 툴들에서 제공하는 상태를 저장하는 기능에 대해서는 또 직접 구현하거나 멱등성을 고려해서 하나하나 코드를 작성해야 한다.</p></blockquote><p>테라폼을 작성함에 있어 가능하면 eksctl을 사용하지 않으면서 진행하려 했다.
eksctl이 대부분 작업을 해주는 것은 cloudformation을 통해 필요한 리소스를 생성해주는 것인데, 이는 충분히 테라폼으로 커버가 가능하다고 생각했다.</p><p>그래서 테라폼 작업을 위해</p><ol><li>AWS 매뉴얼을 보며 AWS콘솔에서 한번 테스트</li><li>AWS CLI 명령어 확인 (AWS CLI는 AWS콘솔에서 보여주지 못한 값들을 요구하는 경우가 많다)</li><li>eksctl의 cloudformation 템플릿 확인</li><li>테라폼 문서 확인</li><li>구글 서칭 (특정 기능은 테라폼에서 만들어서 제공하기도 하고, 그 외에 사용자들이 작성한 모듈에서도 도움을 많이 받았다.)</li></ol><p>이런 방식을 번갈아 가며 확인하며 진행했다. eksctl의 경우 실행 후 클라우드포메이션에서 템플릿과 리소스를 테라폼으로 옮겼다.</p><h3 id=테라폼-템플릿>테라폼 템플릿</h3><p>main 브랜치에는 eks_cluster까지만 구성하고, 각각 feature/nodegroup, feature/fargate 브랜치를 통해 각각의 테스트를 가능하게 해봤다.</p><p>아래는 브랜치별 구성된 내용을 아래처럼 정리해봤다.</p><ul><li><a href=https://github.com/ryusstory/eks-study-terraform>main 브랜치</a><ul><li>VPC + public subnet + eks cluster + bastion host</li></ul></li><li><a href=https://github.com/ryusstory/eks-study-terraform/tree/eks-ec2node>nodegroup 브랜치</a><ul><li>VPC + public subnet + eks cluster + bastion host + EC2 node group</li></ul></li><li><a href=https://github.com/ryusstory/eks-study-terraform/tree/eks-fargate>fargate 브랜치</a><ul><li>VPC + public subnet + eks cluster + bastion host + private subnet + nat gateway + fargate</li></ul></li></ul><h2 id=사용법-설명>사용법 설명</h2><h3 id=git-clone>git clone</h3><p>클론을 받아야 하는데, nodegroup용 branch와 fargate용 브랜치를 나눠놨다.</p><p>그래서 필요한 대로 받으면 되고, main 브랜치의 경우 eks cluster까지만 구성되도록 해놨다.</p><pre><code>git clone -b eks-ec2node https://github.com/ryusstory/eks-study-terraform.git
# or 
git clone -b eks-fargate https://github.com/ryusstory/eks-study-terraform.git

</code></pre><h3 id=aws-credential-설정>AWS credential 설정</h3><p><a href=https://docs.aws.amazon.com/ko_kr/cli/latest/userguide/cli-configure-files.html><code>aws configure</code> 등으로 설정</a>해줘야 한다.</p><h3 id=테라폼-설치>테라폼 설치</h3><p><a href="https://learn.hashicorp.com/tutorials/terraform/install-cli?in=terraform/aws-get-started">테라폼은 기본적으로 설치</a>되어 있어야 한다.</p><h3 id=테라폼-실행>테라폼 실행</h3><p><code>terraform init</code> 을 통해 aws에 필요한 툴을 설치한 뒤 <code>terraform apply</code>로 배포하면 된다.</p><p>처음에는 변수를 편집했어야 하는데, 이 경우 특히 중요한 IP 설정을 놓칠 것 같아 <code>terraform apply</code>를 입력할 경우 변수를 입력받도록 해놨다.</p><p>그래서 <code>terraform apply</code>를 입력할 경우 아래와 같이 ip를 물어보게 된다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt; terraform apply
var.home_cidr
  Enter a value:
</code></pre></div><p>하지만 매번 이 귀찮은 것을 넣을 수 없으니 아래 방법으로 실행하면 된다.</p><h3 id=변수-설정>변수 설정</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>terraform apply -var home_cidr<span style=color:#f92672>=</span>1.2.3.4/32
</code></pre></div><p>혹은 <a href=https://github.com/ryusstory/eks-study-terraform/blob/c48ba8cc47dd1acfad7a9ef327e6068c7fbac659/01.variables.tf#L34-L37>home_cidr variable을 찾아서</a> 직접 넣어서 사용할 수도 있다. 아래처럼 넣어주면 된다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;home_cidr&#34;</span> {<span style=color:#75715e>
</span><span style=color:#75715e>    # 접근할 집 주소 등 설정
</span><span style=color:#75715e></span>    type <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
    default <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1.2.3.4/32&#34;</span>
}
</code></pre></div><p>그 외에도 <a href=https://github.com/ryusstory/eks-study-terraform/blob/c48ba8cc47dd1acfad7a9ef327e6068c7fbac659/01.variables.tf#L48-L64>노드그룹등 설정</a>정도가 포함되어 있다.</p><p>위와 같이 설정하면 <code>terraform apply</code>만으로 바로 배포가 가능하다. <code>terraform deploy</code>를 사용해 지울 때도 변수입력이 필요하기 때문에 변수를 미리 설정해두는 하는 방법이 가장 좋다.</p><h3 id=배포-완료-후-kubectl-설정>배포 완료 후 kubectl 설정</h3><p>배포가 완료되면 바로 kubectl을 사용할 수 있으며 <a href=https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/create-kubeconfig.html><code>aws eks update-kubeconfig --name k8s-eks</code> 를 사용해서 ~/.kube/config 파일을 생성</a>해 준다.</p><p>해당 커맨드는 배포 완료 후 output에서 확인할 수 있고, <code>terraform output</code>을 입력해도 볼 수 있다.</p><p>현재 사용하고 있는 credential 기준으로 업데이트된다. 예를 들면 사용하는 PC 에서는 <code>~/.aws/credentials</code> 파일을 참고하고 EC2 IAM Profile이 있는 EC2에서는 Iam Role 을 기준으로 업데이트된다.</p><p>(EC2 IAM Profile을 생성하는 부분은 여기를 참고)[https://github.com/ryusstory/eks-study-terraform/blob/8711ae552473ec76f2e984372e424d2d0598148a/40.eks_bastion_host.tf#L32-L63]하면 된다.</p><h3 id=bastion-host에서-kubectl-사용하기-kubectl권한을-다른-iam-사용자에게도-설정>bastion host에서 kubectl 사용하기 (kubectl권한을 다른 IAM 사용자에게도 설정)</h3><p>좀 더 이상적인 모델을 위해 bastion host에는 별도 access key를 사용하지 않고, EC2 IAM Profile 을 통해 권한을 부여하도록 했다. 그러다 보니 해당 IAM Role에 kubectl 권한을 줘야 하는데, kubectl 로 컨피그를 받아서 sed로 해당 내용을 추가해서 적용하는 방법도 있긴 한데, 이 경우 윈도우에서 사용할 수가 없어 수동으로 추가하기로 했고, 아래 두 자료를 참고해 직접 넣는 방법을 사용하기로 했다.</p><ul><li><a href=https://aws.amazon.com/ko/premiumsupport/knowledge-center/amazon-eks-cluster-access/>Amazon EKS에서 클러스터를 생성한 후 다른 IAM 사용자 및 역할이 액세스할 수 있도록 하려면 어떻게 해야 합니까?</a></li><li><a href=https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/add-user-role.html>클러스터의 사용자 또는 IAM 역할 관리</a></li></ul><p><code>kubectl edit -n kube-system configmap/aws-auth</code> 명령어를 치면 윈도우의 경우 메모장, 리눅스의 경우 vi 편집기가 나온다.</p><p>그러면 보통 아래와 같은 출력이 나오는데 중간의 추가해야 할 곳에 IAM Role 에 대한 컨피그를 추가해야 한다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># Please edit the object below. Lines beginning with a &#39;#&#39; will be ignored,</span>
<span style=color:#75715e># and an empty file will abort the edit. If an error occurs while saving this file will be</span>
<span style=color:#75715e># reopened with the relevant failures.</span>
<span style=color:#75715e>#</span>
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>data</span>:
  <span style=color:#f92672>mapRoles</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>    - groups:
</span><span style=color:#e6db74>      - system:bootstrappers
</span><span style=color:#e6db74>      - system:nodes
</span><span style=color:#e6db74>      - system:node-proxier
</span><span style=color:#e6db74>      rolearn: arn:aws:iam::123456789012:role/k8s-eks-fargate-profile
</span><span style=color:#e6db74>      username: system:node:{{SessionName}}</span>    
<span style=color:#75715e># ------------ 추가해서 넣어야 할 곳 ------------</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ConfigMap</span>
<span style=color:#f92672>metadata</span>:
  ---<span style=color:#ae81ff>생략---</span>
</code></pre></div><p><a href=https://github.com/ryusstory/eks-study-terraform/blob/8711ae552473ec76f2e984372e424d2d0598148a/40.eks_bastion_host.tf#L185-L196>configmap.yml 파일은 테라폼에서 iam_role 부분을 가져와서 직접 생성</a>했다.
<code>data:</code>, <code>mapRoles:</code> 의 내용을 줄 맞춤을 위한 출력이라 붙여넣으면 안 된다.</p><p><code>./output/configmap.yml</code> 을 열어보면 아래와 같은 내용이 나오는데 mapRoles 아래의 내용을 <code>kubectl edit -n kube-system configmap/aws-auth</code>에 나온 편집기에 mapRoles 리스트에 붙여넣어주면 된다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#e6db74>&#34;data&#34;</span>:
  <span style=color:#f92672>&#34;mapRoles&#34;: </span><span style=color:#ae81ff>|</span>
<span style=color:#75715e># ------------ 여기 아래부터 복사</span>
    - <span style=color:#f92672>rolearn</span>: <span style=color:#ae81ff>arn:aws:iam::123456789012:role/k8s-eks_bastion_host_role</span>
      <span style=color:#f92672>username</span>: <span style=color:#ae81ff>k8s-eks_bastion_host_role</span>
      <span style=color:#f92672>groups</span>:
        - <span style=color:#ae81ff>system:masters</span>
</code></pre></div><p>적용하면 아래와 같이 된다. 붙여넣은 부분 외에 다른 부분은 각자 그리고 배포 방식에 따라 다를 수 있다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># Please edit the object below. Lines beginning with a &#39;#&#39; will be ignored,</span>
<span style=color:#75715e># and an empty file will abort the edit. If an error occurs while saving this file will be</span>
<span style=color:#75715e># reopened with the relevant failures.</span>
<span style=color:#75715e>#</span>
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>data</span>:
  <span style=color:#f92672>mapRoles</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>    - groups:
</span><span style=color:#e6db74>      - system:bootstrappers
</span><span style=color:#e6db74>      - system:nodes
</span><span style=color:#e6db74>      - system:node-proxier
</span><span style=color:#e6db74>      rolearn: arn:aws:iam::123456789012:role/k8s-eks-fargate-profile
</span><span style=color:#e6db74>      username: system:node:{{SessionName}}
</span><span style=color:#e6db74>    - rolearn: arn:aws:iam::123456789012:role/k8s-eks_bastion_host_role   # 붙여넣은 부분
</span><span style=color:#e6db74>      username: k8s-eks_bastion_host_role                                 # 붙여넣은 부분
</span><span style=color:#e6db74>      groups:                                                             # 붙여넣은 부분
</span><span style=color:#e6db74>        - system:masters                                                  # 붙여넣은 부분</span>    
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ConfigMap</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>creationTimestamp</span>: <span style=color:#e6db74>&#34;2021-09-18T13:14:33Z&#34;</span>
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>aws-auth</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>kube-system</span>
  <span style=color:#f92672>resourceVersion</span>: <span style=color:#e6db74>&#34;44084&#34;</span>
  <span style=color:#f92672>uid</span>: <span style=color:#ae81ff>67b19ca3-b8e3-4570-bf24-a03c0ae49cc5</span>
</code></pre></div><p>위처럼 만들고 저장하고 닫으면 바로 설정이 적용된다.</p><p>bastion host가 배포될 때 마지막 스크립트에 <code>aws eks update-kubeconfig --name k8s-eks</code>를 통해 kubeconfig를 업데이트하도록 해놨는데, 이게 먹힐 때가 있고 안 먹힐 때가 있다. 그 이유는 cluster 생성중에는 해당 커맨드를 사용할 수가 없어 EKS Cluster보다 Bastion host가 먼저 생성될 경우 <code>Cluster status is CREATING</code> 메세지와 함께 업데이트 되지 않는다.</p><p>아무튼 bastion host에서도 테라폼 생성 완료 후 aws-auth를 설정하고 <code>aws eks update-kubeconfig --name k8s-eks</code> 설정을 해주면 된다.</p><h3 id=option-bastion_host-접속-시-윈도우에서-keypair-파일-권한>(option) bastion_host 접속 시 윈도우에서 keypair 파일 권한</h3><p>putty와 같은 ssh 접속 프로그램을 사용하면 아래와 같은 문제는 없는데, 윈도우에서 예전에는 지원을 안했지만 이제는 단순히 cmd창 혹은 powershell창에서 <code>ssh</code>를 사용할 수 있어서 해당 방식으로 접근할때는 아래와 같은 작업이 필요하다.</p><pre><code>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@         WARNING: UNPROTECTED PRIVATE KEY FILE!          @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
Permissions for './outputs/aws_ssh_keypair.pem' are too open.
It is required that your private key files are NOT accessible by others.
This private key will be ignored.
Load key &quot;./outputs/aws_ssh_keypair.pem&quot;: bad permissions
</code></pre><p>리눅스나 맥의 경우 단순히 파일 생성 시 권한을 400으로 설정해서 바로 접근이 가능하지만 윈도우의 경우 테라폼에서 이러한 권한을 설정할 수가 없기 때문에 직접 권한 상속을 처리해줘야해서 좀 귀찮지만 직접 스크립트를 사용해야 한다.</p><p><a href=https://techsoda.net/windows10-pem-file-permission-settings/>GUI를 통해 설정하는 방법</a>도 있긴 하지만 스크립트를 사용하면 더 간단하다.</p><p>CMD를 사용할 경우 (.\scrits\windows-cmd.bat)를 실행하면 된다.</p><pre><code>.\scripts\windows-cmd.bat
</code></pre><p>Powershell의 경우에는 기본적으로 파워셀에서 파워셀 스크립트 실행을 막아놔서 <a href=./outputs/windows-powershell.ps1>파워쉘용 스크립트</a>를 열어 내용으로 복사해서 파워쉘에 붙여넣으면 된다.</p><p>생각해보자면 좀 더 편하게 하려면 내 PC의 Access key를 그냥 EC2에 넣어서 설정하면 되지만 공부를 위한 목적이라 해당 부분을 조금 불편하더라도 이렇게 구성했다.</p><h3 id=파일설명>파일설명</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>│  00.provider.tf           <span style=color:#75715e># 테라폼 기본 환경 설정 파일</span>
│  01.variables.tf          <span style=color:#75715e># 변수 설정 파일</span>
│  10.vpc+public_subnets.tf <span style=color:#75715e># VPC, 서브넷 배포 템플릿</span>
│  20.eks_cluster_role.tf   <span style=color:#75715e># eks 클러스터용 role 배포 템플릿</span>
│  21.eks_cluster.tf        <span style=color:#75715e># eks 클러스터 배포 템플릿</span>
│  40.eks_bastion_host.tf   <span style=color:#75715e># eks 접속용 bastion host 배포 템플릿</span>
│  README.md                <span style=color:#75715e># README</span>
├─scripts
│  ├─windows-cmd.bat        <span style=color:#75715e># 윈도우용 ssh keypair 권한 설정 스크립트</span>
│  └─windows-powersehll.ps1 <span style=color:#75715e># 파워쉘용 ssh keypair 권한 설정 스크립트</span>
└─outputs                   <span style=color:#75715e># aws keypair 등 output이 생겼을때 파일을 담을 폴더</span>
</code></pre></div><p>각 두 자리 숫자마다 사용하려는 용도 정리를 하면 아래와 같다.</p><p>00 대역은 기본적인 설정
10 대역은 기본적인 인프라 설정
20 대역은 EKS Cluster 관련 설정
30 대역은 Node group or fargate 관련 설정
40 대역은 bastion hosts 관련 설정</p><h3 id=위-내용을-구성도로-그리면-아래와-같다>위 내용을 구성도로 그리면 아래와 같다.</h3><p><img src=https://user-images.githubusercontent.com/20898758/133926419-dd739d6b-3199-460f-ba5b-d2c0de5b177f.png alt=image></p><h2 id=aws-eks-on-nodegroup>AWS EKS on Nodegroup</h2><p>배포되고 나면 bastion host에 배포 스크립트로 워커노드에 쉽게 접속하는 것을 넣어놨다.</p><p><a href=https://github.com/ryusstory/eks-study-terraform/blob/8711ae552473ec76f2e984372e424d2d0598148a/40.eks_bastion_host.tf#L166-L182><code>/set_worker_node.sh</code> 를 실행</a>하면 아래처럼 <code>/usr/local/bin/</code> 폴더에 워커노드의 정보가 들어가고 <code>w1</code>, <code>w2</code> 와 같은 명령어를 통해 바로 워커노드로 바로 접속이 가능하다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>root@eksctl-host ~<span style=color:#f92672>]</span><span style=color:#75715e># /set_worker_node.sh </span>
WORKER_NODES exists
<span style=color:#f92672>[</span>root@eksctl-host ~<span style=color:#f92672>]</span><span style=color:#75715e># ls -al /usr/local/bin/w*</span>
-rwxr-xr-x <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>87</span> Sep <span style=color:#ae81ff>19</span> 20:06 /usr/local/bin/w1
-rwxr-xr-x <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>87</span> Sep <span style=color:#ae81ff>19</span> 20:06 /usr/local/bin/w2
<span style=color:#f92672>[</span>root@eksctl-host ~<span style=color:#f92672>]</span><span style=color:#75715e># w1</span>
Warning: Permanently added <span style=color:#e6db74>&#39;192.168.1.139&#39;</span> <span style=color:#f92672>(</span>ECDSA<span style=color:#f92672>)</span> to the list of known hosts.
Last login: Sun Sep <span style=color:#ae81ff>19</span> 11:05:10 <span style=color:#ae81ff>2021</span> from ip-192-168-0-100.ap-northeast-2.compute.internal

       __|  __|_  <span style=color:#f92672>)</span>
       _|  <span style=color:#f92672>(</span>     /   Amazon Linux <span style=color:#ae81ff>2</span> AMI
      ___|<span style=color:#ae81ff>\_</span>__|___|

https://aws.amazon.com/amazon-linux-2/
<span style=color:#f92672>[</span>ec2-user@ip-192-168-1-139 ~<span style=color:#f92672>]</span>$ exit
logout
Connection to 192.168.1.139 closed.
<span style=color:#f92672>[</span>root@eksctl-host ~<span style=color:#f92672>]</span><span style=color:#75715e># w2</span>
Warning: Permanently added <span style=color:#e6db74>&#39;192.168.2.222&#39;</span> <span style=color:#f92672>(</span>ECDSA<span style=color:#f92672>)</span> to the list of known hosts.
Last login: Sun Sep <span style=color:#ae81ff>19</span> 11:05:11 <span style=color:#ae81ff>2021</span> from ip-192-168-0-100.ap-northeast-2.compute.internal

       __|  __|_  <span style=color:#f92672>)</span>
       _|  <span style=color:#f92672>(</span>     /   Amazon Linux <span style=color:#ae81ff>2</span> AMI
      ___|<span style=color:#ae81ff>\_</span>__|___|

https://aws.amazon.com/amazon-linux-2/
<span style=color:#f92672>[</span>ec2-user@ip-192-168-2-222 ~<span style=color:#f92672>]</span>$ 
</code></pre></div><h2 id=aws-eks-on-fargate>AWS EKS on Fargate</h2><p>처음 terraform 을 작성하고 그 뒤로 fargate 배포 형태를 적용해봤다.</p><ul><li><a href=https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/fargate-getting-started.html>https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/fargate-getting-started.html</a></li></ul><p>하지만 기본적으로 EC2 노드그룹에서 사용하던 eks cluster는 fargate로 사용하려면 문제가 있었다.</p><p>배포 직후 coredns 상태를 보면 아래와 같다</p><pre><code>[root@eksctl-host ~]# kubectl get deployment -n kube-system
NAME      READY   UP-TO-DATE   AVAILABLE   AGE
coredns   0/2     2            0           21m
</code></pre><p><a href=https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/fargate-getting-started.html>fargate로 사용하려면 aws 문서</a>를 통해 fargate profile과 coredns profile을 설정해주어야만 제대로 동작한다.</p><p>fargate profile은 모두 terraform에 포함되어 있기에 coredns 배포에 대해 패치만 해주면 coredns가 정상적으로 올라온다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl patch deployment coredns -n kube-system --type json -p<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;[{&#34;op&#34;: &#34;remove&#34;, &#34;path&#34;: &#34;/spec/template/metadata/annotations/eks.amazonaws.com~1compute-type&#34;}]&#39;</span>
</code></pre></div><p>fargate 배포에 대한 설정을 k8sfp 네임스페이스에 대해 셀렉터를 설정해 두었다.</p><p>그래서 먼저 <code>kubectl create namespace k8sfp</code>로 네임스페이스를 생성하고 <code>kubens k8sfp</code>나 <code>kubectl config set-context --current --namespace=k8sfp</code>로 네임스페이스를 전환해 사용하면 된다.</p><p>네임스페이스를 변경하고 배포하면 fargate에 배포되게 된다. 그리고 fargate로 배포하면 배포당 약 1분~정도 소요된다.</p><pre><code>[root@eksctl-host ~]# kubectl get deployment
NAME                READY   UP-TO-DATE   AVAILABLE   AGE
nginx-to-scaleout   3/3     3            3           15m
[root@eksctl-host ~]#
</code></pre><h3 id=리소스-삭제>리소스 삭제</h3><p>클라우드포메이션도 마찬가지겠지만 삭제 시에는 eks에서 로드밸런서와 같은 AWS 자원을 삭제 후 테라폼을 삭제해야 한다.</p><p>그래서 <code>kubectl get deployment --all-namespaces</code>등으로 확인해서 kube-system 외의 네임스페이스에서 배포된 자원들을 삭제 후</p><p><code>terraform destroy -var home_cidr=1.2.3.4/32</code> 명령어를 통해 자원을 삭제하면 된다.</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/terraform/ rel=tag>terraform</a></li><li class=tags__item><a class="tags__link btn" href=/tags/akos/ rel=tag>akos</a></li><li class=tags__item><a class="tags__link btn" href=/tags/eks/ rel=tag>eks</a></li><li class=tags__item><a class="tags__link btn" href=/tags/aws/ rel=tag>aws</a></li></ul></div></footer></article></main><div class="authorbox clearfix"><figure class=authorbox__avatar><img alt="Ryusstory avatar" src=/img/avatar.png class=avatar height=90 width=90></figure><div class=authorbox__header><span class=authorbox__name>About Ryusstory</span></div><div class=authorbox__description>Ryu. DevOps</div></div><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/post/210916-helloworld/ rel=prev><span class=pager__subtitle>«&#8201;Previous</span><p class=pager__title>Hello World</p></a></div></nav><section class=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//ryusstory.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div><aside class=sidebar><div class="widget-search widget"><form class=widget-search__form role=search method=get action=https://google.com/search><label><input class=widget-search__field type=search placeholder=SEARCH… name=q aria-label=SEARCH…></label>
<input class=widget-search__submit type=submit value=Search>
<input type=hidden name=sitesearch value=https://ryusstory.github.io/></form></div><div class="widget-recent widget"><h4 class=widget__title>Recent Posts</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/post/210918-eks-terraform/>AWS EKS Terraform 작성</a></li><li class=widget__item><a class=widget__link href=/post/210916-helloworld/>Hello World</a></li><li class=widget__item><a class=widget__link href=/post/221212-terraform-cf-alb-sg/>Hello World</a></li></ul></div></div><div class="widget-categories widget"><h4 class=widget__title>Categories</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/categories/blog/>blog</a></li><li class=widget__item><a class=widget__link href=/categories/tech/>tech</a></li></ul></div></div><div class="widget-taglist widget"><h4 class=widget__title>Tags</h4><div class=widget__content><a class="widget-taglist__link widget__link btn" href=/tags/akos/ title=akos>akos</a>
<a class="widget-taglist__link widget__link btn" href=/tags/aws/ title=aws>aws</a>
<a class="widget-taglist__link widget__link btn" href=/tags/blog/ title=blog>blog</a>
<a class="widget-taglist__link widget__link btn" href=/tags/eks/ title=eks>eks</a>
<a class="widget-taglist__link widget__link btn" href=/tags/github-pages/ title="github pages">github pages</a>
<a class="widget-taglist__link widget__link btn" href=/tags/hugo/ title=hugo>hugo</a>
<a class="widget-taglist__link widget__link btn" href=/tags/t101/ title=t101>t101</a>
<a class="widget-taglist__link widget__link btn" href=/tags/terraform/ title=terraform>terraform</a></div></div></aside></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2022 Ryusstory.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script><script src=/js/custom.js></script></body></html>