<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Cloudfront 와 ALB 보안그룹 설정 테라폼으로만 구성하기 - Ryusstory</title><script>(function(a,b){a[b]=a[b].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content="Example article description"><meta property="og:title" content="Cloudfront 와 ALB 보안그룹 설정 테라폼으로만 구성하기"><meta property="og:description" content="Example article description"><meta property="og:type" content="article"><meta property="og:url" content="https://ryusstory.github.io/post/221212-terraform-cf-alb-sg/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-12-12T21:28:55+09:00"><meta property="article:modified_time" content="2022-12-12T21:28:55+09:00"><meta itemprop=name content="Cloudfront 와 ALB 보안그룹 설정 테라폼으로만 구성하기"><meta itemprop=description content="Example article description"><meta itemprop=datePublished content="2022-12-12T21:28:55+09:00"><meta itemprop=dateModified content="2022-12-12T21:28:55+09:00"><meta itemprop=wordCount content="1599"><meta itemprop=keywords content="terraform,aws,t101,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Cloudfront 와 ALB 보안그룹 설정 테라폼으로만 구성하기"><meta name=twitter:description content="Example article description"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class="logo logo--mixed"><a class=logo__link href=/ title=Ryusstory rel=home><div class="logo__item logo__imagebox"><img class=logo__img src=/img/noise.jpg></div><div class="logo__item logo__text"><div class=logo__title>Ryusstory</div><div class=logo__tagline>Brainprints</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/post/210918-eks-terraform/><span class=menu__text>AWS EKS Terraform 작성</span></a></li><li class="menu__item menu__item--active"><a class=menu__link href=/post/221212-terraform-cf-alb-sg/><span class=menu__text>Cloudfront 와 ALB 보안그룹 설정 테라폼으로만 구성하기</span></a></li><li class=menu__item><a class=menu__link href=/post/210916-helloworld/><span class=menu__text>Hello World</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Cloudfront 와 ALB 보안그룹 설정 테라폼으로만 구성하기</h1><p class=post__lead>Cloudfront 와 ALB 보안그룹 설정 테라폼으로만 구성하기</p><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>Ryusstory</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2022-12-12T21:28:55+09:00>2022-12-12</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/tech/ rel=category>tech</a></span></div></div></header><div class="post__toc toc"><div class=toc__title>Page content</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#소개>소개</a></li><li><a href=#cloudfront와-alb의-보안구성>Cloudfront와 ALB의 보안구성</a></li><li><a href=#사전에-알아야-할-지식>사전에 알아야 할 지식</a><ul><li><a href=#aws-limits>AWS Limits</a></li><li><a href=#최소-지식-조건-loop>최소 지식 조건 loop</a></li></ul></li><li><a href=#선구자가-이미-있다>선구자가 이미 있다</a></li><li><a href=#data를-까보자-with-terraform-console>data를 까보자 with terraform console</a></li><li><a href=#terraform에서-어떻게-적용할지-고민을-해보자>terraform에서 어떻게 적용할지 고민을 해보자</a></li><li><a href=#블로그의-좋은-것들을-훔쳐오자>블로그의 좋은 것들을 훔쳐오자</a></li><li><a href=#이제-테라폼을-만들어봅시다>이제 테라폼을 만들어봅시다</a></li></ul></nav></div></div><div class="content post__content clearfix"><h2 id=소개>소개</h2><p>이 글을 쓰게 된 계기는 다른 글을 쓰다가 Cloudfront와 ALB의 보안 구성을 어떻게 하면 테라폼으로 편하게 배포할까 고민하다가 생각보다 잘 동작하는걸 보고 쓰게 되었습니다.</p><p>기존에 lambda를 통해 보안그룹을 업데이트가 가능하지만 이를 테라폼으로 가능한 것을 확인하고 quota를 적용하지 않고 순수 상태로 cloudfront용 보안그룹을 만들어 보려합니다.</p><h2 id=cloudfront와-alb의-보안구성>Cloudfront와 ALB의 보안구성</h2><p>먼저 보통 Cloudfront를 붙여서 구성하게 되면 아래와 같이 인프라가 구성되게 됩니다.</p><p><img src=https://user-images.githubusercontent.com/20898758/207043038-fadd5e46-faa8-4ae9-87d4-3e130cb6e9e9.png alt=image></p><p>Cloudfront를 통해서 내부 인프라에 접근하는 구성인데요. 유저는 실제 Cloudfront랑 통신하고 Cloudfront가 내부 S3나 ALB와 연결을 중계 해주는 방식입니다.</p><p>그런데 제대로 구성하지 않으면 S3의 경우나 ALB를 외부에서 모두 접근가능하도록 구성하기도 합니다.</p><p>S3의 경우 OAI (Origin Access Identity)로 쉽게(?) 구성이 가능하지만 Cloudfront-ALB의 경우 아래 두가지 방법이 있습니다.</p><ul><li>Cloudfront에서 사용하는 IP만 허용하는 보안그룹을 사용하는 방법 <a href=https://aws.amazon.com/ko/blogs/security/how-to-automatically-update-your-security-groups-for-amazon-cloudfront-and-aws-waf-by-using-aws-lambda/>https://aws.amazon.com/ko/blogs/security/how-to-automatically-update-your-security-groups-for-amazon-cloudfront-and-aws-waf-by-using-aws-lambda/</a></li><li>로드밸런서에서 특정 헤더를 허용하고 Cloudfront에서 ALB로 요청시 특정 헤더를 사용하는 방법<a href=https://docs.aws.amazon.com/ko_kr/AmazonCloudFront/latest/DeveloperGuide/restrict-access-to-load-balancer.html>https://docs.aws.amazon.com/ko_kr/AmazonCloudFront/latest/DeveloperGuide/restrict-access-to-load-balancer.html</a></li></ul><p>읽어봐서는 ip로 제한하는 것이 더 강력한 방법인 것 같기도 하고 그렇습니다.</p><p>제가 아는 정도로는 대부분 이 IP 리스트 보안그룹을 통해서 사용하는 것으로 알고 있고 저도 회사에서 저렇게 사용하고 있습니다. 위의 Lambda를 생성해서 사용했었는데요.</p><p>이 글에서는 저 Lambda에서 하는 일을 Terraform에서 적용하는 걸 해보려 합니다.</p><h2 id=사전에-알아야-할-지식>사전에 알아야 할 지식</h2><h3 id=aws-limits>AWS Limits</h3><p>아마존을 사용해 보신 분들은 많이들 겪어서 아시겠지만 생각보다 AWS에는 Limitation이 많습니다.</p><p>일단 여기서 알아야 될 할당량은…</p><ul><li>EC2의 최대 보안그룹 개수<ul><li>EC2에 보안 그룹은 EC2에 바로 붙는게 아니라 EC2에 ENI(네트워크 인터페이스)가 추가되고 ENI에 보안그룹이 붙는 형태입니다. 여기에 일단 한계점이 하나 있습니다.</li><li>기본 값이 최대 5개이고 quota를 통해서 증가시킬 수 있습니다.</li></ul></li><li>보안그룹의 최대 정책(rule) 개수<ul><li>보안 그룹 안에 넣을 수 있는 inbound rule(들어오는 정책)은 기본 최대 60개이고 이 역시 quota를 통해서 증가시킬 수 있습니다.</li></ul></li><li>관련 정보<ul><li><a href=https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/amazon-vpc-limits.html#vpc-limits-security-groups>https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/amazon-vpc-limits.html#vpc-limits-security-groups</a></li></ul></li></ul><p>위 quota에서 할당량 증가를 요청하면 여러개의 보안그룹에 나누지 않아도 넣을 수 있겠지만 제가 하려고 한 부분은 quota를 손대지 않고 terraform으로 이 리스트를 ALB에 넣기는 쉽지 않습니다.</p><p>예전에는 aws에서 ip list를 제공하고 여기서 니네가 알아서 뽑아써 느낌이었는데, 이제는 별도로 리스트를 제공하네요 ㅎㅎ</p><ul><li>IP list 관련된 아마존 공식문서<ul><li><a href=https://docs.aws.amazon.com/ko_kr/AmazonCloudFront/latest/DeveloperGuide/LocationsOfEdgeServers.html>https://docs.aws.amazon.com/ko_kr/AmazonCloudFront/latest/DeveloperGuide/LocationsOfEdgeServers.html</a></li></ul></li><li>전체 IP list<ul><li><a href=https://ip-ranges.amazonaws.com/ip-ranges.json>https://ip-ranges.amazonaws.com/ip-ranges.json</a></li></ul></li><li>Cloudfront IP list<ul><li><a href=https://d7uri8nf7uskq.cloudfront.net/tools/list-cloudfront-ips>https://d7uri8nf7uskq.cloudfront.net/tools/list-cloudfront-ips</a></li></ul></li></ul><p>그냥 세기는 어려우니 cloudfront ip 주소를 개수를 한번 확인해보겠습니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>cloudFrontIpList</span>
{
  <span style=color:#a6e22e>CLOUDFRONT_GLOBAL_IP_LIST</span><span style=color:#f92672>:</span> [
    <span style=color:#e6db74>&#39;120.52.22.96/27&#39;</span>,    <span style=color:#e6db74>&#39;205.251.249.0/24&#39;</span>,   <span style=color:#e6db74>&#39;180.163.57.128/26&#39;</span>,
    <span style=color:#e6db74>&#39;204.246.168.0/22&#39;</span>,   <span style=color:#e6db74>&#39;18.160.0.0/15&#39;</span>,      <span style=color:#e6db74>&#39;205.251.252.0/23&#39;</span>,
    <span style=color:#e6db74>&#39;54.192.0.0/16&#39;</span>,      <span style=color:#e6db74>&#39;204.246.173.0/24&#39;</span>,   <span style=color:#e6db74>&#39;54.230.200.0/21&#39;</span>,
    <span style=color:#e6db74>&#39;120.253.240.192/26&#39;</span>, <span style=color:#e6db74>&#39;116.129.226.128/26&#39;</span>, <span style=color:#e6db74>&#39;130.176.0.0/17&#39;</span>,
    <span style=color:#e6db74>&#39;108.156.0.0/14&#39;</span>,     <span style=color:#e6db74>&#39;99.86.0.0/16&#39;</span>,       <span style=color:#e6db74>&#39;205.251.200.0/21&#39;</span>,
    <span style=color:#e6db74>&#39;223.71.71.128/25&#39;</span>,   <span style=color:#e6db74>&#39;13.32.0.0/15&#39;</span>,       <span style=color:#e6db74>&#39;120.253.245.128/26&#39;</span>,
    <span style=color:#e6db74>&#39;13.224.0.0/14&#39;</span>,      <span style=color:#e6db74>&#39;70.132.0.0/18&#39;</span>,      <span style=color:#e6db74>&#39;15.158.0.0/16&#39;</span>,
    <span style=color:#e6db74>&#39;13.249.0.0/16&#39;</span>,      <span style=color:#e6db74>&#39;18.238.0.0/15&#39;</span>,      <span style=color:#e6db74>&#39;18.244.0.0/15&#39;</span>,
    <span style=color:#e6db74>&#39;205.251.208.0/20&#39;</span>,   <span style=color:#e6db74>&#39;65.9.128.0/18&#39;</span>,      <span style=color:#e6db74>&#39;130.176.128.0/18&#39;</span>,
    <span style=color:#e6db74>&#39;58.254.138.0/25&#39;</span>,    <span style=color:#e6db74>&#39;54.230.208.0/20&#39;</span>,    <span style=color:#e6db74>&#39;3.160.0.0/14&#39;</span>,
    <span style=color:#e6db74>&#39;116.129.226.0/25&#39;</span>,   <span style=color:#e6db74>&#39;52.222.128.0/17&#39;</span>,    <span style=color:#e6db74>&#39;18.164.0.0/15&#39;</span>,
    <span style=color:#e6db74>&#39;64.252.128.0/18&#39;</span>,    <span style=color:#e6db74>&#39;205.251.254.0/24&#39;</span>,   <span style=color:#e6db74>&#39;54.230.224.0/19&#39;</span>,
    <span style=color:#e6db74>&#39;71.152.0.0/17&#39;</span>,      <span style=color:#e6db74>&#39;216.137.32.0/19&#39;</span>,    <span style=color:#e6db74>&#39;204.246.172.0/24&#39;</span>,
    <span style=color:#e6db74>&#39;18.172.0.0/15&#39;</span>,      <span style=color:#e6db74>&#39;120.52.39.128/27&#39;</span>,   <span style=color:#e6db74>&#39;118.193.97.64/26&#39;</span>,
    <span style=color:#e6db74>&#39;223.71.71.96/27&#39;</span>,    <span style=color:#e6db74>&#39;18.154.0.0/15&#39;</span>,      <span style=color:#e6db74>&#39;54.240.128.0/18&#39;</span>,
    <span style=color:#e6db74>&#39;205.251.250.0/23&#39;</span>,   <span style=color:#e6db74>&#39;180.163.57.0/25&#39;</span>,    <span style=color:#e6db74>&#39;52.46.0.0/18&#39;</span>,
    <span style=color:#e6db74>&#39;223.71.11.0/27&#39;</span>,     <span style=color:#e6db74>&#39;52.82.128.0/19&#39;</span>,     <span style=color:#e6db74>&#39;54.230.0.0/17&#39;</span>,
    <span style=color:#e6db74>&#39;54.230.128.0/18&#39;</span>,    <span style=color:#e6db74>&#39;54.239.128.0/18&#39;</span>,    <span style=color:#e6db74>&#39;130.176.224.0/20&#39;</span>,
    <span style=color:#e6db74>&#39;36.103.232.128/26&#39;</span>,  <span style=color:#e6db74>&#39;52.84.0.0/15&#39;</span>,       <span style=color:#e6db74>&#39;143.204.0.0/16&#39;</span>,
    <span style=color:#e6db74>&#39;144.220.0.0/16&#39;</span>,     <span style=color:#e6db74>&#39;120.52.153.192/26&#39;</span>,  <span style=color:#e6db74>&#39;119.147.182.0/25&#39;</span>,
    <span style=color:#e6db74>&#39;120.232.236.0/25&#39;</span>,   <span style=color:#e6db74>&#39;54.182.0.0/16&#39;</span>,      <span style=color:#e6db74>&#39;58.254.138.128/26&#39;</span>,
    <span style=color:#e6db74>&#39;120.253.245.192/27&#39;</span>, <span style=color:#e6db74>&#39;54.239.192.0/19&#39;</span>,    <span style=color:#e6db74>&#39;18.68.0.0/16&#39;</span>,
    <span style=color:#e6db74>&#39;18.64.0.0/14&#39;</span>,       <span style=color:#e6db74>&#39;120.52.12.64/26&#39;</span>,    <span style=color:#e6db74>&#39;99.84.0.0/16&#39;</span>,
    <span style=color:#e6db74>&#39;130.176.192.0/19&#39;</span>,   <span style=color:#e6db74>&#39;52.124.128.0/17&#39;</span>,    <span style=color:#e6db74>&#39;204.246.164.0/22&#39;</span>,
    <span style=color:#e6db74>&#39;13.35.0.0/16&#39;</span>,       <span style=color:#e6db74>&#39;204.246.174.0/23&#39;</span>,   <span style=color:#e6db74>&#39;36.103.232.0/25&#39;</span>,
    <span style=color:#e6db74>&#39;119.147.182.128/26&#39;</span>, <span style=color:#e6db74>&#39;118.193.97.128/25&#39;</span>,  <span style=color:#e6db74>&#39;120.232.236.128/26&#39;</span>,
    <span style=color:#e6db74>&#39;204.246.176.0/20&#39;</span>,   <span style=color:#e6db74>&#39;65.8.0.0/16&#39;</span>,        <span style=color:#e6db74>&#39;65.9.0.0/17&#39;</span>,
    <span style=color:#e6db74>&#39;108.138.0.0/15&#39;</span>,     <span style=color:#e6db74>&#39;120.253.241.160/27&#39;</span>, <span style=color:#e6db74>&#39;64.252.64.0/18&#39;</span>
  ],
  <span style=color:#a6e22e>CLOUDFRONT_REGIONAL_EDGE_IP_LIST</span><span style=color:#f92672>:</span> [
    <span style=color:#e6db74>&#39;13.113.196.64/26&#39;</span>,  <span style=color:#e6db74>&#39;13.113.203.0/24&#39;</span>,  <span style=color:#e6db74>&#39;52.199.127.192/26&#39;</span>,
    <span style=color:#e6db74>&#39;13.124.199.0/24&#39;</span>,   <span style=color:#e6db74>&#39;3.35.130.128/25&#39;</span>,  <span style=color:#e6db74>&#39;52.78.247.128/26&#39;</span>,
    <span style=color:#e6db74>&#39;13.233.177.192/26&#39;</span>, <span style=color:#e6db74>&#39;15.207.13.128/25&#39;</span>, <span style=color:#e6db74>&#39;15.207.213.128/25&#39;</span>,
    <span style=color:#e6db74>&#39;52.66.194.128/26&#39;</span>,  <span style=color:#e6db74>&#39;13.228.69.0/24&#39;</span>,   <span style=color:#e6db74>&#39;52.220.191.0/26&#39;</span>,
    <span style=color:#e6db74>&#39;13.210.67.128/26&#39;</span>,  <span style=color:#e6db74>&#39;13.54.63.128/26&#39;</span>,  <span style=color:#e6db74>&#39;99.79.169.0/24&#39;</span>,
    <span style=color:#e6db74>&#39;18.192.142.0/23&#39;</span>,   <span style=color:#e6db74>&#39;35.158.136.0/24&#39;</span>,  <span style=color:#e6db74>&#39;52.57.254.0/24&#39;</span>,
    <span style=color:#e6db74>&#39;13.48.32.0/24&#39;</span>,     <span style=color:#e6db74>&#39;18.200.212.0/23&#39;</span>,  <span style=color:#e6db74>&#39;52.212.248.0/26&#39;</span>,
    <span style=color:#e6db74>&#39;3.10.17.128/25&#39;</span>,    <span style=color:#e6db74>&#39;3.11.53.0/24&#39;</span>,     <span style=color:#e6db74>&#39;52.56.127.0/25&#39;</span>,
    <span style=color:#e6db74>&#39;15.188.184.0/24&#39;</span>,   <span style=color:#e6db74>&#39;52.47.139.0/24&#39;</span>,   <span style=color:#e6db74>&#39;18.229.220.192/26&#39;</span>,
    <span style=color:#e6db74>&#39;54.233.255.128/26&#39;</span>, <span style=color:#e6db74>&#39;3.231.2.0/25&#39;</span>,     <span style=color:#e6db74>&#39;3.234.232.224/27&#39;</span>,
    <span style=color:#e6db74>&#39;3.236.169.192/26&#39;</span>,  <span style=color:#e6db74>&#39;3.236.48.0/23&#39;</span>,    <span style=color:#e6db74>&#39;34.195.252.0/24&#39;</span>,
    <span style=color:#e6db74>&#39;34.226.14.0/24&#39;</span>,    <span style=color:#e6db74>&#39;13.59.250.0/26&#39;</span>,   <span style=color:#e6db74>&#39;18.216.170.128/25&#39;</span>,
    <span style=color:#e6db74>&#39;3.128.93.0/24&#39;</span>,     <span style=color:#e6db74>&#39;3.134.215.0/24&#39;</span>,   <span style=color:#e6db74>&#39;52.15.127.128/26&#39;</span>,
    <span style=color:#e6db74>&#39;3.101.158.0/23&#39;</span>,    <span style=color:#e6db74>&#39;52.52.191.128/26&#39;</span>, <span style=color:#e6db74>&#39;34.216.51.0/25&#39;</span>,
    <span style=color:#e6db74>&#39;34.223.12.224/27&#39;</span>,  <span style=color:#e6db74>&#39;34.223.80.192/26&#39;</span>, <span style=color:#e6db74>&#39;35.162.63.192/26&#39;</span>,
    <span style=color:#e6db74>&#39;35.167.191.128/26&#39;</span>, <span style=color:#e6db74>&#39;44.227.178.0/24&#39;</span>,  <span style=color:#e6db74>&#39;44.234.108.128/25&#39;</span>,
    <span style=color:#e6db74>&#39;44.234.90.252/30&#39;</span>
  ]
}
<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>cloudFrontIpList</span>.<span style=color:#a6e22e>CLOUDFRONT_GLOBAL_IP_LIST</span>.<span style=color:#a6e22e>length</span>
<span style=color:#ae81ff>84</span>
<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>cloudFrontIpList</span>.<span style=color:#a6e22e>CLOUDFRONT_REGIONAL_EDGE_IP_LIST</span>.<span style=color:#a6e22e>length</span>
<span style=color:#ae81ff>49</span>
<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>cloudFrontIpList</span>.<span style=color:#a6e22e>CLOUDFRONT_GLOBAL_IP_LIST</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>cloudFrontIpList</span>.<span style=color:#a6e22e>CLOUDFRONT_REGIONAL_EDGE_IP_LIST</span>.<span style=color:#a6e22e>length</span>
<span style=color:#ae81ff>133</span>
<span style=color:#f92672>&gt;</span>
</code></pre></div><p>총 133개 네요!</p><p>아까 말씀드린 quota를 증가시키지 않고 적용할 경우 60개를 꽉꽉 채운다고 했을 때, 133/60 하면 최소 3개의 보안그룹이 필요하겠네요.</p><h3 id=최소-지식-조건-loop>최소 지식 조건 loop</h3><p>다른 언어를 통해서도 좋고 테라폼을 통해서도 좋고 적어도 loop 에 대해서는 조금 이해가 있어야 쉽게 보실 수 있습니다.</p><p><a href=https://developer.hashicorp.com/terraform/language/expressions/for>https://developer.hashicorp.com/terraform/language/expressions/for</a></p><p>그리고 이 글에서는 count 를 통해서 리소스를 생성하는 방식으로 진행했습니다.</p><p>리소스에 <code>count</code>를 통해서 생성해본 적 있거나 <code>count.index</code> 가 어떻게 적용되는지 정도는 알아야 이해가 어렵지 않습니다.</p><p><a href=https://developer.hashicorp.com/terraform/language/meta-arguments/count>https://developer.hashicorp.com/terraform/language/meta-arguments/count</a></p><h2 id=선구자가-이미-있다>선구자가 이미 있다</h2><p>이걸 어떻게 적용할까 고민하다가 찾아보니 이미 외국에 적용한 사람이 있더라구요. 그것도 무려 2019년에…</p><p><a href=https://jonnyzzz.com/blog/2019/03/26/terraform-cloudfront-sg/>https://jonnyzzz.com/blog/2019/03/26/terraform-cloudfront-sg/</a></p><p>여기서 찾아본적도 없지만… 엄청 난걸 알았습니다. 테라폼에서 data source로 aws clodufront ip list를 제공한다는걸요!</p><p><a href=https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/ip_ranges>https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/ip_ranges</a></p><p>그리고 위 블로그는 133개 IP를 30개씩 나눠서 5개 보안 그룹을 사용하는데요. 그렇게 되면 Cloudfront 용도 보안그룹으로만 가득 채워지게 되니까 사용하기 좀 안좋을 것 같아서 좀 개선을 하고 싶었고, 어떤 과정을 통해서 적용했는지 정리해봤습니다.</p><h2 id=data를-까보자-with-terraform-console>data를 까보자 with terraform console</h2><p>약간 제가 삽질할때 쓰는 도구인데요. console이 생각보다 별로지만(?) 생각보다 유용합니다</p><p>일단 <a href=http://main.tf>main.tf</a> 파일로 아래 내용을 넣어서 하나 만들어줍니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#a6e22e>terraform</span> {
  <span style=color:#a6e22e>required_providers</span> {
    <span style=color:#a6e22e>aws</span> <span style=color:#f92672>=</span> {
      <span style=color:#a6e22e>source</span>  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hashicorp/aws&#34;</span>
      <span style=color:#a6e22e>version</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;~&gt; 4.0&#34;</span>
    }
  }
}

<span style=color:#a6e22e>provider</span> <span style=color:#e6db74>&#34;aws&#34;</span> {
  <span style=color:#a6e22e>region</span>  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ap-northeast-2&#34;</span>
}

<span style=color:#a6e22e>data</span> <span style=color:#e6db74>&#34;aws_ip_ranges&#34;</span> <span style=color:#e6db74>&#34;cloudfront&#34;</span> {
    <span style=color:#a6e22e>services</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;cloudfront&#34;</span>]
}

<span style=color:#a6e22e>locals</span> {
  <span style=color:#a6e22e>foo</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bar&#34;</span>
}

<span style=color:#a6e22e>variable</span> <span style=color:#e6db74>&#34;foo&#34;</span> {
  <span style=color:#66d9ef>default</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;b&#34;</span>,<span style=color:#e6db74>&#34;a&#34;</span>,<span style=color:#e6db74>&#34;r&#34;</span>]
}
</code></pre></div><p>보통 다른 사람 코드를 가져와서 쓰다보면 이런 데이터가 어떻게 들어있는지 어떻게 가지고 놀아야 하는지 어려울 때가 많은데요. 저도 계속 그래왔었고 대부분 terraform 설정 파일 안의 값을 output으로 뽑거나 해서 확인했었는데요. 여기서 console을 확인하면 이것저것 미리 테스트가 가능합니다.</p><p>그럼 위에서 만든 <code>data</code>, <code>local</code>, <code>variable</code> 이 어떻게 console에서 보이는지 한번 보겠습니다.</p><p>먼저 위 내용만 가지고 <code>terraform init</code> 를 해줍니다.</p><p><code>terraform console</code> 을 입력하면 아래처럼 프롬프트가 뜨게 되는데 현재 폴더의 tf파일을 읽어온 채로 console을 실행하게 됩니다!</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#a6e22e>ryusstory</span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>Rucas</span><span style=color:#f92672>-</span><span style=color:#a6e22e>MacBookPro</span> <span style=color:#f92672>~</span><span style=color:#960050;background-color:#1e0010>/provider_test ❯ tf init   </span>

<span style=color:#a6e22e>Initializing</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>backend</span>...

<span style=color:#a6e22e>Initializing</span> <span style=color:#a6e22e>provider</span> <span style=color:#a6e22e>plugins</span>...
<span style=color:#f92672>-</span> <span style=color:#a6e22e>Finding</span> <span style=color:#a6e22e>hashicorp</span><span style=color:#f92672>/</span><span style=color:#a6e22e>aws</span> <span style=color:#a6e22e>versions</span> <span style=color:#a6e22e>matching</span> <span style=color:#e6db74>&#34;~&gt; 4.0&#34;</span>...
<span style=color:#f92672>-</span> <span style=color:#a6e22e>Installing</span> <span style=color:#a6e22e>hashicorp</span><span style=color:#f92672>/</span><span style=color:#a6e22e>aws</span> <span style=color:#a6e22e>v4</span><span style=color:#ae81ff>.46.0</span>...
<span style=color:#f92672>-</span> <span style=color:#a6e22e>Installed</span> <span style=color:#a6e22e>hashicorp</span><span style=color:#f92672>/</span><span style=color:#a6e22e>aws</span> <span style=color:#a6e22e>v4</span><span style=color:#ae81ff>.46.0</span> (<span style=color:#a6e22e>signed</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>HashiCorp</span>)

<span style=color:#a6e22e>Terraform</span> <span style=color:#a6e22e>has</span> <span style=color:#a6e22e>created</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>lock</span> <span style=color:#a6e22e>file</span> .<span style=color:#a6e22e>terraform</span>.<span style=color:#a6e22e>lock</span>.<span style=color:#a6e22e>hcl</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>record</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>provider</span>
<span style=color:#a6e22e>selections</span> <span style=color:#a6e22e>it</span> <span style=color:#a6e22e>made</span> <span style=color:#a6e22e>above</span>. <span style=color:#a6e22e>Include</span> <span style=color:#66d9ef>this</span> <span style=color:#a6e22e>file</span> <span style=color:#66d9ef>in</span> <span style=color:#a6e22e>your</span> <span style=color:#a6e22e>version</span> <span style=color:#a6e22e>control</span> <span style=color:#a6e22e>repository</span>
<span style=color:#a6e22e>so</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>Terraform</span> <span style=color:#a6e22e>can</span> <span style=color:#a6e22e>guarantee</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>make</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>same</span> <span style=color:#a6e22e>selections</span> <span style=color:#a6e22e>by</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>when</span>
<span style=color:#a6e22e>you</span> <span style=color:#a6e22e>run</span> <span style=color:#e6db74>&#34;terraform init&#34;</span> <span style=color:#66d9ef>in</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>future</span>.

<span style=color:#a6e22e>Terraform</span> <span style=color:#a6e22e>has</span> <span style=color:#a6e22e>been</span> <span style=color:#a6e22e>successfully</span> <span style=color:#a6e22e>initialized</span><span style=color:#f92672>!</span>

<span style=color:#a6e22e>You</span> <span style=color:#a6e22e>may</span> <span style=color:#a6e22e>now</span> <span style=color:#a6e22e>begin</span> <span style=color:#a6e22e>working</span> <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>Terraform</span>. <span style=color:#a6e22e>Try</span> <span style=color:#a6e22e>running</span> <span style=color:#e6db74>&#34;terraform plan&#34;</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>see</span>
<span style=color:#a6e22e>any</span> <span style=color:#a6e22e>changes</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>are</span> <span style=color:#a6e22e>required</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>your</span> <span style=color:#a6e22e>infrastructure</span>. <span style=color:#a6e22e>All</span> <span style=color:#a6e22e>Terraform</span> <span style=color:#a6e22e>commands</span>
<span style=color:#a6e22e>should</span> <span style=color:#a6e22e>now</span> <span style=color:#a6e22e>work</span>.

<span style=color:#a6e22e>If</span> <span style=color:#a6e22e>you</span> <span style=color:#a6e22e>ever</span> <span style=color:#a6e22e>set</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>change</span> <span style=color:#a6e22e>modules</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>backend</span> <span style=color:#a6e22e>configuration</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>Terraform</span>,
<span style=color:#a6e22e>rerun</span> <span style=color:#66d9ef>this</span> <span style=color:#a6e22e>command</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>reinitialize</span> <span style=color:#a6e22e>your</span> <span style=color:#a6e22e>working</span> <span style=color:#a6e22e>directory</span>. <span style=color:#a6e22e>If</span> <span style=color:#a6e22e>you</span> <span style=color:#a6e22e>forget</span>, <span style=color:#a6e22e>other</span>
<span style=color:#a6e22e>commands</span> <span style=color:#a6e22e>will</span> <span style=color:#a6e22e>detect</span> <span style=color:#a6e22e>it</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>remind</span> <span style=color:#a6e22e>you</span> <span style=color:#a6e22e>to</span> <span style=color:#66d9ef>do</span> <span style=color:#a6e22e>so</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>necessary</span>.
<span style=color:#960050;background-color:#1e0010>❯</span> <span style=color:#a6e22e>terraform</span> <span style=color:#a6e22e>console</span>
<span style=color:#f92672>&gt;</span>
</code></pre></div><p>먼저 우리가 위 data를 사용할 때 <code>data.aws_ip_ranges.cloudfront</code> 를 통해서 사용하게 되는데요. 그대로 콘솔에서 한번 보겠습니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>aws_ip_ranges</span>.<span style=color:#a6e22e>cloudfront</span>
(<span style=color:#a6e22e>known</span> <span style=color:#a6e22e>after</span> <span style=color:#a6e22e>apply</span>)
<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>local</span>.<span style=color:#a6e22e>foo</span>
<span style=color:#e6db74>&#34;bar&#34;</span>
<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>var</span>.<span style=color:#a6e22e>foo</span>
[
  <span style=color:#e6db74>&#34;b&#34;</span>,
  <span style=color:#e6db74>&#34;a&#34;</span>,
  <span style=color:#e6db74>&#34;r&#34;</span>,
]
<span style=color:#f92672>&gt;</span>
</code></pre></div><p>data는 적어도 한번 <code>apply</code>를 해서 aws에서 내용을 가져와야 그 내용을 볼 수 있지만 locals나 variables는 바로 여기서 확인이 가능합니다</p><p>그러면 <code>exit</code> 로 나가서 terraform apply를 한번 해보겠습니다.</p><p>적용할게 없으니까 그동안 봐왔던 yes도 물어보지 않고 알아서 적용됩니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#960050;background-color:#1e0010>❯</span> <span style=color:#a6e22e>terraform</span> <span style=color:#a6e22e>apply</span>  
<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>aws_ip_ranges</span>.<span style=color:#a6e22e>cloudfront</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Reading</span>...
<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>aws_ip_ranges</span>.<span style=color:#a6e22e>cloudfront</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Read</span> <span style=color:#a6e22e>complete</span> <span style=color:#a6e22e>after</span> <span style=color:#ae81ff>1</span><span style=color:#a6e22e>s</span> [<span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1670634785</span>]

<span style=color:#a6e22e>No</span> <span style=color:#a6e22e>changes</span>. <span style=color:#a6e22e>Your</span> <span style=color:#a6e22e>infrastructure</span> <span style=color:#a6e22e>matches</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>configuration</span>.

<span style=color:#a6e22e>Terraform</span> <span style=color:#a6e22e>has</span> <span style=color:#a6e22e>compared</span> <span style=color:#a6e22e>your</span> <span style=color:#a6e22e>real</span> <span style=color:#a6e22e>infrastructure</span> <span style=color:#a6e22e>against</span> <span style=color:#a6e22e>your</span> <span style=color:#a6e22e>configuration</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>found</span> <span style=color:#a6e22e>no</span> <span style=color:#a6e22e>differences</span>, <span style=color:#a6e22e>so</span> <span style=color:#a6e22e>no</span> <span style=color:#a6e22e>changes</span> <span style=color:#a6e22e>are</span> <span style=color:#a6e22e>needed</span>.

<span style=color:#a6e22e>Apply</span> <span style=color:#a6e22e>complete</span><span style=color:#f92672>!</span> <span style=color:#a6e22e>Resources</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span> <span style=color:#a6e22e>added</span>, <span style=color:#ae81ff>0</span> <span style=color:#a6e22e>changed</span>, <span style=color:#ae81ff>0</span> <span style=color:#a6e22e>destroyed</span>.
<span style=color:#960050;background-color:#1e0010>❯</span>
</code></pre></div><p>다시 콘솔로 가서 <code>data.aws_ip_ranges.cloudfront</code> 를 보겠습니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>aws_ip_ranges</span>.<span style=color:#a6e22e>cloudfront</span> 
{
  <span style=color:#e6db74>&#34;cidr_blocks&#34;</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tolist</span>([
    <span style=color:#e6db74>&#34;108.138.0.0/15&#34;</span>,
    <span style=color:#a6e22e>생략</span>...
    <span style=color:#e6db74>&#34;99.86.0.0/16&#34;</span>,
  ])
  <span style=color:#e6db74>&#34;create_date&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;2022-12-10-01-13-05&#34;</span>
  <span style=color:#e6db74>&#34;id&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1670634785&#34;</span>
  <span style=color:#e6db74>&#34;ipv6_cidr_blocks&#34;</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tolist</span>([
    <span style=color:#e6db74>&#34;2400:7fc0:500::/40&#34;</span>,
    <span style=color:#a6e22e>생략</span>...
    <span style=color:#e6db74>&#34;2600:9000:fff::/48&#34;</span>,
  ])
  <span style=color:#e6db74>&#34;regions&#34;</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>toset</span>(<span style=color:#66d9ef>null</span>) <span style=color:#75715e>/* of string */</span>
  <span style=color:#e6db74>&#34;services&#34;</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>toset</span>([
    <span style=color:#e6db74>&#34;cloudfront&#34;</span>,
  ])
  <span style=color:#e6db74>&#34;sync_token&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1670634785</span>
  <span style=color:#e6db74>&#34;url&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://ip-ranges.amazonaws.com/ip-ranges.json&#34;</span>
}
<span style=color:#f92672>&gt;</span>
</code></pre></div><p>엄청나죠…?자세히 보면 앞의 문서(<a href=https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/ip_ranges>https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/ip_ranges</a>)에서 attribute reference 값들이 여기서 다 보이는 걸 알 수 있습니다.</p><p>문서에서 쓸 수 있다는 <code>cidr_blocks</code>, <code>ipv6_cidr_blocks</code>, <code>create_date</code>, <code>sync_token</code>까지 data_source안에서 다 보이는 걸 확인할 수 있습니다.</p><p>그런데.. 가만 보니… 거기에 없는 값도 쓸 수 있네요?! (쓰면 책임 못지겠지만요)</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>aws_ip_ranges</span>.<span style=color:#a6e22e>cloudfront</span>.<span style=color:#a6e22e>url</span>
<span style=color:#e6db74>&#34;https://ip-ranges.amazonaws.com/ip-ranges.json&#34;</span>
<span style=color:#f92672>&gt;</span>
</code></pre></div><p>이제 여기서 앞의 블로그에서 얻은 내용과 앞의 할당량을 조합해서 어떻게 배포하면 될지 한번 보겠습니다.</p><p>저희는 <code>cidr_blocks</code> attribute만 사용할 것이기 때문에 이것만 가져와서 앞에서 본 개수와 비교해 보겠습니다.</p><p>테라폼에서는 length 라는 function이 있고, 그 외에도 많은 function이 있습니다. 꼭 한번 봐두면 좋습니다.</p><p><a href=https://developer.hashicorp.com/terraform/language/functions/length>https://developer.hashicorp.com/terraform/language/functions/length</a></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>length</span>(<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>aws_ip_ranges</span>.<span style=color:#a6e22e>cloudfront</span>.<span style=color:#a6e22e>cidr_blocks</span>)
<span style=color:#ae81ff>133</span>
<span style=color:#f92672>&gt;</span>
</code></pre></div><p>앞의 133개와 동일하네요! 그렇다면 이걸 가지고 쓰면 될 것 같습니다!</p><p>그리고 description에 create_date를 한번 넣어볼게요.</p><h2 id=terraform에서-어떻게-적용할지-고민을-해보자>terraform에서 어떻게 적용할지 고민을 해보자</h2><p>자 이제 133개를 아까 할당량으로 보면 최대 60개인데 꽉 채울수도 있을것 같지만 왠지 꽉 채우면 아무래도 좀 찝찝하니까 55개로 해보겠습니다. 왜냐면… 50개는 17개만 대역이 추가되면 보안그룹 개수가 하나 늘어야 하니까…</p><p>현재기준 133개를 좀 안정적으로 나누려면 마지막 보안그룹에 최대 개수의 반정도만 찼으면 좋겠거든요. IP list가 변경되어도 보안그룹이 추가되거나 삭제되지 않도록요.</p><p>그러면 55개로 하면 55 + 55 + 23 = 133 이렇게 들어가면 마지막 보안그룹에 들어갈 ingress rule이 23/55(41%)로 뭔가 좀 안정감을 얻을 수 있을것 같습니다.</p><h2 id=블로그의-좋은-것들을-훔쳐오자>블로그의 좋은 것들을 훔쳐오자</h2><p>그렇다면 이제 앞의 블로그에서 본 것중에서 chunklist만 마저 훔쳐오면 될 것 같습니다.</p><p><a href=https://developer.hashicorp.com/terraform/language/functions/chunklist>https://developer.hashicorp.com/terraform/language/functions/chunklist</a></p><p>문서는 이렇구요. 정리하면 제가 정한 숫자를 최대값으로 list를 나눠줍니다.</p><p>1~133까지의 숫자가 든 list가 있다고 하면</p><p><code>[1,2,3,…,131,132,133]</code></p><p>chunklist 로 50 개씩 나누면 아래처럼 나눠집니다.</p><p><code>[[1,2,...,49,50],[51,52,...,99,100],[101,102,...,132,133]]</code></p><p>그럼 이제 콘솔을 통해서 또 테스트해보겠습니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>chunklist</span>(<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>aws_ip_ranges</span>.<span style=color:#a6e22e>cloudfront</span>.<span style=color:#a6e22e>cidr_blocks</span>,<span style=color:#ae81ff>55</span>)
<span style=color:#a6e22e>tolist</span>([
  <span style=color:#a6e22e>tolist</span>([
    <span style=color:#e6db74>&#34;108.138.0.0/15&#34;</span>,
    <span style=color:#a6e22e>생략</span>...
    <span style=color:#e6db74>&#34;180.163.57.128/26&#34;</span>,
  ]),
  <span style=color:#a6e22e>tolist</span>([
    <span style=color:#e6db74>&#34;204.246.164.0/22&#34;</span>,
    <span style=color:#a6e22e>생략</span>...
    <span style=color:#e6db74>&#34;52.84.0.0/15&#34;</span>,
  ]),
  <span style=color:#a6e22e>tolist</span>([
    <span style=color:#e6db74>&#34;54.182.0.0/16&#34;</span>,
    <span style=color:#a6e22e>생략</span>...
    <span style=color:#e6db74>&#34;99.86.0.0/16&#34;</span>,
  ]),
])
</code></pre></div><p>원하는 대로 나왔네요!</p><p>물론.. 현재 가진 리스트보다 큰 숫자를 입력하면 그냥 그대로 뽑아서 리스트에 넣어줍니다.</p><p><code>[1,2,3,4,5]</code> 의 리스트가 있고, <code>chunklist([1,2,3,4,5],10)</code> 을 하면 <code>[[1,2,3,4,5]]</code> 로 나옵니다.</p><p>그러면 원래대로 돌아와서 각 리스트의 개수를 확인도 해보겠습니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>length</span>(<span style=color:#a6e22e>chunklist</span>(<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>aws_ip_ranges</span>.<span style=color:#a6e22e>cloudfront</span>.<span style=color:#a6e22e>cidr_blocks</span>,<span style=color:#ae81ff>55</span>))
<span style=color:#ae81ff>3</span>
<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>length</span>(<span style=color:#a6e22e>chunklist</span>(<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>aws_ip_ranges</span>.<span style=color:#a6e22e>cloudfront</span>.<span style=color:#a6e22e>cidr_blocks</span>,<span style=color:#ae81ff>55</span>)[<span style=color:#ae81ff>0</span>])
<span style=color:#ae81ff>55</span>
<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>length</span>(<span style=color:#a6e22e>chunklist</span>(<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>aws_ip_ranges</span>.<span style=color:#a6e22e>cloudfront</span>.<span style=color:#a6e22e>cidr_blocks</span>,<span style=color:#ae81ff>55</span>)[<span style=color:#ae81ff>1</span>])
<span style=color:#ae81ff>55</span>
<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>length</span>(<span style=color:#a6e22e>chunklist</span>(<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>aws_ip_ranges</span>.<span style=color:#a6e22e>cloudfront</span>.<span style=color:#a6e22e>cidr_blocks</span>,<span style=color:#ae81ff>55</span>)[<span style=color:#ae81ff>2</span>])
<span style=color:#ae81ff>23</span>
</code></pre></div><p>총 3개의 리스트로 구성되었구요 앞서 생각한대로 55 55 23으로 나눠졌습니다.</p><p>그래서 리스트 3개가 들어있는 리스트가 만들어 졌다고 생각하시면 됩니다!</p><p>이제 이걸 테라폼으로 넣어봅시다!</p><h2 id=이제-테라폼을-만들어봅시다>이제 테라폼을 만들어봅시다</h2><p>먼저 위에서 해봤던 chunklist로 55개로 나눠주고 local 변수에 넣어줍니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#a6e22e>locals</span> {
  <span style=color:#a6e22e>cloudfront_ipv4_cidr_chunklist</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${chunklist(data.aws_ip_ranges.cloudfront.cidr_blocks, 55)}&#34;</span>
	<span style=color:#75715e>// chunklist를 통해서 list를 나눠줍니다. 총3개 리스트가 들어있을 겁니다.
</span><span style=color:#75715e></span>}
</code></pre></div><p>이제 count를 통해서 보안그룹을 만들어 볼게요</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#a6e22e>resource</span> <span style=color:#e6db74>&#34;aws_security_group&#34;</span> <span style=color:#e6db74>&#34;cloudfront&#34;</span> {
  <span style=color:#a6e22e>count</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>length</span>(<span style=color:#a6e22e>local</span>.<span style=color:#a6e22e>cloudfront_ipv4_cidr_chunklist</span>)
  <span style=color:#75715e>// 앞의 콘솔에서 확인한대로 리스트 3개가 들어있으니까 length()를 사용하면 3이 나옵니다.
</span><span style=color:#75715e></span>  <span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;cloudfront security group for ALB-${count.index}&#34;</span> <span style=color:#75715e>// 보기 쉽게 보안그룹에 이름을 달아줍시다
</span><span style=color:#75715e></span>  <span style=color:#a6e22e>ingress</span> {
    <span style=color:#a6e22e>from_port</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
    <span style=color:#a6e22e>to_port</span>   <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
    <span style=color:#a6e22e>protocol</span>  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;tcp&#34;</span>
    <span style=color:#a6e22e>cidr_blocks</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>local</span>.<span style=color:#a6e22e>cloudfront_ipv4_cidr_chunklist</span>[<span style=color:#a6e22e>count</span>.<span style=color:#a6e22e>index</span>] <span style=color:#75715e>// cidr_blocks에는 list를 넣어줘야하는데, 저희는 이미 리스트를 가지고 있으므로 그대로 넣어줍니다!
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>description</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${data.aws_ip_ranges.cloudfront.create_date}-${count.index}&#34;</span> 
    <span style=color:#75715e>// description도 앞서 얘기한대로 create_date와 count.index를 조합해서 넣어줍니다.
</span><span style=color:#75715e></span>  }
  <span style=color:#a6e22e>egress</span> {
    <span style=color:#a6e22e>from_port</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
    <span style=color:#a6e22e>to_port</span>   <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
    <span style=color:#a6e22e>protocol</span>  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;-1&#34;</span>
    <span style=color:#a6e22e>cidr_blocks</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;0.0.0.0/0&#34;</span>]
  }
  <span style=color:#a6e22e>lifecycle</span> {
    <span style=color:#a6e22e>create_before_destroy</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
  }
}
</code></pre></div><p>이제 apply를 해보겠습니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#a6e22e>생략</span>...
<span style=color:#a6e22e>Enter</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>yes</span>

<span style=color:#a6e22e>aws_security_group</span>.<span style=color:#a6e22e>cloudfront</span>[<span style=color:#ae81ff>2</span>]<span style=color:#f92672>:</span> <span style=color:#a6e22e>Creating</span>...
<span style=color:#a6e22e>aws_security_group</span>.<span style=color:#a6e22e>cloudfront</span>[<span style=color:#ae81ff>1</span>]<span style=color:#f92672>:</span> <span style=color:#a6e22e>Creating</span>...
<span style=color:#a6e22e>aws_security_group</span>.<span style=color:#a6e22e>cloudfront</span>[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>:</span> <span style=color:#a6e22e>Creating</span>...
<span style=color:#a6e22e>aws_security_group</span>.<span style=color:#a6e22e>cloudfront</span>[<span style=color:#ae81ff>2</span>]<span style=color:#f92672>:</span> <span style=color:#a6e22e>Creation</span> <span style=color:#a6e22e>complete</span> <span style=color:#a6e22e>after</span> <span style=color:#ae81ff>2</span><span style=color:#a6e22e>s</span> [<span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#a6e22e>sg</span><span style=color:#f92672>-</span><span style=color:#ae81ff>0</span><span style=color:#a6e22e>a9e63770cc558c32</span>]
<span style=color:#a6e22e>aws_security_group</span>.<span style=color:#a6e22e>cloudfront</span>[<span style=color:#ae81ff>1</span>]<span style=color:#f92672>:</span> <span style=color:#a6e22e>Creation</span> <span style=color:#a6e22e>complete</span> <span style=color:#a6e22e>after</span> <span style=color:#ae81ff>2</span><span style=color:#a6e22e>s</span> [<span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#a6e22e>sg</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span><span style=color:#a6e22e>c06a56dce4bf000</span>]
<span style=color:#a6e22e>aws_security_group</span>.<span style=color:#a6e22e>cloudfront</span>[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>:</span> <span style=color:#a6e22e>Creation</span> <span style=color:#a6e22e>complete</span> <span style=color:#a6e22e>after</span> <span style=color:#ae81ff>2</span><span style=color:#a6e22e>s</span> [<span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#a6e22e>sg</span><span style=color:#f92672>-</span><span style=color:#ae81ff>0</span><span style=color:#a6e22e>a2bf94b78840ae04</span>]

<span style=color:#a6e22e>Apply</span> <span style=color:#a6e22e>complete</span><span style=color:#f92672>!</span> <span style=color:#a6e22e>Resources</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>3</span> <span style=color:#a6e22e>added</span>, <span style=color:#ae81ff>0</span> <span style=color:#a6e22e>changed</span>, <span style=color:#ae81ff>0</span> <span style=color:#a6e22e>destroyed</span>.
<span style=color:#a6e22e>ryusstory</span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>Rucas</span><span style=color:#f92672>-</span><span style=color:#a6e22e>MacBookPro</span> <span style=color:#f92672>~</span><span style=color:#960050;background-color:#1e0010>/provider_test 7s ❯</span>
</code></pre></div><p>생각한대로 3개 그룹이 잘 생성됐네요 AWS에 들어가서 한번 보겠습니다.</p><p><img src=https://user-images.githubusercontent.com/20898758/207043119-351592d0-54bf-4ce9-975f-a94191bd32ac.png alt=image></p><p>항목도 55 55 23으로 잘 나왔고 description도 잘 나왔네요! 그런데 index가 0부터 되니까 좀 보기 싫네요!</p><p>description 부분을 0,1,2 가 아니라 1,2,3으로 나오도록 아래처럼 해보겠습니다. 보안그룹이름도 CF를 위한 ALB 보안그룹이 더 맞겠네요</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#a6e22e>resource</span> <span style=color:#e6db74>&#34;aws_security_group&#34;</span> <span style=color:#e6db74>&#34;cloudfront&#34;</span> {
  ...
  <span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ALB security group for Cloudfront-${count.index+1}&#34;</span>
  <span style=color:#a6e22e>ingress</span> {
    ...
    <span style=color:#a6e22e>description</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${data.aws_ip_ranges.cloudfront.create_date}-${count.index+1}&#34;</span> 
  }
}
</code></pre></div><p><img src=https://user-images.githubusercontent.com/20898758/207043135-92a20bc5-0d48-40e0-90df-f1c00dee8663.png alt=image>
만족</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/terraform/ rel=tag>terraform</a></li><li class=tags__item><a class="tags__link btn" href=/tags/aws/ rel=tag>aws</a></li><li class=tags__item><a class="tags__link btn" href=/tags/t101/ rel=tag>t101</a></li></ul></div></footer></article></main><div class="authorbox clearfix"><figure class=authorbox__avatar><img alt="Ryusstory avatar" src=/img/avatar.png class=avatar height=90 width=90></figure><div class=authorbox__header><span class=authorbox__name>About Ryusstory</span></div><div class=authorbox__description>Ryu. DevOps</div></div><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/post/210918-eks-terraform/ rel=prev><span class=pager__subtitle>«&#8201;Previous</span><p class=pager__title>AWS EKS Terraform 작성</p></a></div></nav></div><aside class=sidebar><div class="widget-search widget"><form class=widget-search__form role=search method=get action=https://google.com/search><label><input class=widget-search__field type=search placeholder=SEARCH… name=q aria-label=SEARCH…></label>
<input class=widget-search__submit type=submit value=Search>
<input type=hidden name=sitesearch value=https://ryusstory.github.io/></form></div><div class="widget-recent widget"><h4 class=widget__title>Recent Posts</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/post/221212-terraform-cf-alb-sg/>Cloudfront 와 ALB 보안그룹 설정 테라폼으로만 구성하기</a></li><li class=widget__item><a class=widget__link href=/post/210918-eks-terraform/>AWS EKS Terraform 작성</a></li><li class=widget__item><a class=widget__link href=/post/210916-helloworld/>Hello World</a></li></ul></div></div><div class="widget-categories widget"><h4 class=widget__title>Categories</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/categories/blog/>blog</a></li><li class=widget__item><a class=widget__link href=/categories/tech/>tech</a></li></ul></div></div><div class="widget-taglist widget"><h4 class=widget__title>Tags</h4><div class=widget__content><a class="widget-taglist__link widget__link btn" href=/tags/akos/ title=akos>akos</a>
<a class="widget-taglist__link widget__link btn" href=/tags/aws/ title=aws>aws</a>
<a class="widget-taglist__link widget__link btn" href=/tags/blog/ title=blog>blog</a>
<a class="widget-taglist__link widget__link btn" href=/tags/eks/ title=eks>eks</a>
<a class="widget-taglist__link widget__link btn" href=/tags/github-pages/ title="github pages">github pages</a>
<a class="widget-taglist__link widget__link btn" href=/tags/hugo/ title=hugo>hugo</a>
<a class="widget-taglist__link widget__link btn" href=/tags/t101/ title=t101>t101</a>
<a class="widget-taglist__link widget__link btn" href=/tags/terraform/ title=terraform>terraform</a></div></div></aside></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2022 Ryusstory.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script><script src=/js/custom.js></script></body></html>